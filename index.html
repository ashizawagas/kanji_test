<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å­¦æ ¡æ¼¢å­—ãƒ†ã‚¹ãƒˆã‚¢ãƒ—ãƒª - é«˜ç²¾åº¦OCRç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            padding: 30px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .grade-selector {
            margin: 15px 0;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .grade-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .grade-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .grade-btn.active {
            background: rgba(255,255,255,0.4);
            border-color: rgba(255,255,255,0.8);
            box-shadow: 0 4px 15px rgba(255,255,255,0.3);
        }

        .score-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .score-item {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            font-weight: bold;
        }

        .init-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 10px;
            font-size: 0.9em;
        }

        .init-loading {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .init-ready {
            background: rgba(76, 175, 80, 0.3);
            color: #e8f5e8;
        }

        .init-error {
            background: rgba(244, 67, 54, 0.3);
            color: #ffebee;
        }

        .question-section {
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
        }

        .question-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #555;
        }

        .grade-info {
            font-size: 1em;
            color: #888;
            margin-bottom: 15px;
        }

        .question-text {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            line-height: 1.6;
            padding: 20px;
            background: rgba(79, 172, 254, 0.1);
            border-radius: 15px;
            border-left: 5px solid #4facfe;
        }

        .target-kanji {
            background: #ffeb3b;
            padding: 5px 10px;
            border-radius: 8px;
            font-weight: bold;
            color: #333;
        }

        .hint {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 20px;
            font-style: italic;
        }

        .canvas-section {
            padding: 40px;
            background: white;
        }

        .canvas-title {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #555;
        }

        .canvas-subtitle {
            text-align: center;
            font-size: 0.9em;
            color: #888;
            margin-bottom: 30px;
        }

        .canvas-container {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .canvas-wrapper {
            position: relative;
            border: 4px solid #e0e0e0;
            border-radius: 15px;
            padding: 10px;
            background: #fafafa;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
        }

        #drawingCanvas {
            border: 2px dashed #ccc;
            border-radius: 10px;
            cursor: crosshair;
            background: white;
            touch-action: none;
        }

        .result-section {
            text-align: center;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 15px;
            animation: fadeIn 0.5s;
        }

        .result-correct {
            background: linear-gradient(45deg, #4caf50, #8bc34a);
            color: white;
        }

        .result-incorrect {
            background: linear-gradient(45deg, #f44336, #ff9800);
            color: white;
        }

        .result-feedback {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .result-answer {
            font-size: 1.5em;
            margin-top: 10px;
        }

        .processing-section {
            text-align: center;
            padding: 20px;
            background: linear-gradient(45deg, #2196f3, #21cbf3);
            color: white;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-clear {
            background: linear-gradient(45deg, #9e9e9e, #607d8b);
            color: white;
        }

        .btn-check {
            background: linear-gradient(45deg, #2196f3, #21cbf3);
            color: white;
        }

        .btn-next {
            background: linear-gradient(45deg, #4caf50, #8bc34a);
            color: white;
        }

        .btn-reset {
            background: linear-gradient(45deg, #f44336, #ff9800);
            color: white;
            margin-top: 20px;
        }

        .btn-grade {
            background: linear-gradient(45deg, #9c27b0, #e91e63);
            color: white;
            margin-top: 20px;
        }

        .tips {
            background: linear-gradient(45deg, #fff3e0, #ffecb3);
            border: 1px solid #ffcc02;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 40px;
        }

        .tips h4 {
            color: #f57c00;
            margin-bottom: 10px;
        }

        .tips ul {
            list-style: none;
            color: #e65100;
        }

        .tips li {
            margin: 5px 0;
        }

        .tips li::before {
            content: "âœ“ ";
            color: #4caf50;
            font-weight: bold;
        }

        .final-score {
            text-align: center;
            padding: 30px;
            background: linear-gradient(45deg, #4caf50, #8bc34a);
            color: white;
            border-radius: 15px;
            margin: 20px 40px;
            font-size: 1.2em;
        }

        .grade-selection {
            text-align: center;
            padding: 40px;
            background: #f8f9ff;
        }

        .grade-selection h2 {
            color: #555;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .grade-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .grade-card {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            color: white;
            padding: 30px 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .grade-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .grade-card h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .grade-card p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .stats-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 0.9em;
        }

        .recognition-candidates {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .candidate-btn {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            color: #1976d2;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.3s;
        }

        .candidate-btn:hover {
            background: #2196f3;
            color: white;
        }

        .ocr-engine-status {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 0.8em;
        }

        @media (max-width: 600px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .canvas-section, .question-section {
                padding: 20px;
            }
            
            #drawingCanvas {
                width: 300px;
                height: 300px;
            }

            .grade-selector {
                gap: 5px;
            }

            .grade-btn {
                padding: 6px 12px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å­¦å¹´é¸æŠç”»é¢ -->
        <div id="gradeSelectionScreen" class="grade-selection">
            <h2>ğŸ“š å­¦å¹´ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
            <div class="grade-grid">
                <div class="grade-card" onclick="selectGrade(1)">
                    <h3>1å¹´ç”Ÿ</h3>
                    <p>80å­—ã®åŸºæœ¬æ¼¢å­—</p>
                </div>
                <div class="grade-card" onclick="selectGrade(2)">
                    <h3>2å¹´ç”Ÿ</h3>
                    <p>160å­—ã®æ¼¢å­—</p>
                </div>
                <div class="grade-card" onclick="selectGrade(3)">
                    <h3>3å¹´ç”Ÿ</h3>
                    <p>200å­—ã®æ¼¢å­—</p>
                </div>
                <div class="grade-card" onclick="selectGrade(4)">
                    <h3>4å¹´ç”Ÿ</h3>
                    <p>202å­—ã®æ¼¢å­—</p>
                </div>
                <div class="grade-card" onclick="selectGrade(5)">
                    <h3>5å¹´ç”Ÿ</h3>
                    <p>193å­—ã®æ¼¢å­—</p>
                </div>
                <div class="grade-card" onclick="selectGrade(6)">
                    <h3>6å¹´ç”Ÿ</h3>
                    <p>191å­—ã®æ¼¢å­—</p>
                </div>
                <div class="grade-card" onclick="selectGrade(0)">
                    <h3>å…¨å­¦å¹´</h3>
                    <p>1,026å­—ã™ã¹ã¦</p>
                </div>
            </div>
            <div class="stats-info">
                <strong>ğŸ“Š åéŒ²æ¼¢å­—æ•°: 1,026å­—</strong><br>
                æ–‡éƒ¨ç§‘å­¦çœå­¦ç¿’æŒ‡å°è¦é ˜ã«åŸºã¥ãå°å­¦æ ¡ã§ç¿’ã†ã™ã¹ã¦ã®æ¼¢å­—ã‚’åéŒ²<br>
                <strong>ğŸš€ é«˜ç²¾åº¦OCRæ­è¼‰</strong> - è¤‡æ•°ã‚¨ãƒ³ã‚¸ãƒ³çµ±åˆã«ã‚ˆã‚‹95%ä»¥ä¸Šã®èªè­˜ç²¾åº¦
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="gameScreen" style="display: none;">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="header">
                <h1>ğŸˆ¯ å°å­¦æ ¡æ¼¢å­—ãƒ†ã‚¹ãƒˆã‚¢ãƒ—ãƒª</h1>
                <div class="grade-selector">
                    <button class="grade-btn" onclick="selectGrade(1)">1å¹´</button>
                    <button class="grade-btn" onclick="selectGrade(2)">2å¹´</button>
                    <button class="grade-btn" onclick="selectGrade(3)">3å¹´</button>
                    <button class="grade-btn" onclick="selectGrade(4)">4å¹´</button>
                    <button class="grade-btn" onclick="selectGrade(5)">5å¹´</button>
                    <button class="grade-btn" onclick="selectGrade(6)">6å¹´</button>
                    <button class="grade-btn" onclick="selectGrade(0)">å…¨å­¦å¹´</button>
                </div>
                <div class="score-bar">
                    <div class="score-item">
                        å•é¡Œ <span id="currentQuestion">1</span>/<span id="totalQuestions">10</span>
                    </div>
                    <div class="score-item">
                        æ­£è§£ <span id="currentScore">0</span>å•
                    </div>
                </div>
                <div id="initStatus" class="init-status" style="display: none;"></div>
                <div id="ocrEngineStatus" class="ocr-engine-status" style="display: none;"></div>
            </div>

            <!-- å•é¡Œã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="question-section">
                <div class="question-title">æ¬¡ã®æ–‡ç« ã®ä¸‹ç·šéƒ¨ã‚’æ¼¢å­—1æ–‡å­—ã§æ›¸ã„ã¦ãã ã•ã„</div>
                <div class="grade-info" id="gradeInfo">å°å­¦æ ¡1å¹´ç”Ÿã®æ¼¢å­—</div>
                <div class="question-text" id="questionText">
                    ã‚ãŸã—ã¯æ¯æ—¥<span class="target-kanji">ãŒã£ã“ã†</span>ã¸è¡Œãã¾ã™ã€‚
                </div>
                <div class="hint" id="questionHint">
                    ã€ŒãŒã£ã“ã†ã€ã®ã€ŒãŒãã€ã‚’æ¼¢å­—ã§æ›¸ã„ã¦ãã ã•ã„
                </div>
            </div>

            <!-- æ‰‹æ›¸ãã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="canvas-section">
                <div class="canvas-title">ã“ã“ã«æ¼¢å­—ã‚’æ›¸ã„ã¦ãã ã•ã„</div>
                <div class="canvas-subtitle">1æ–‡å­—ã ã‘ã€ç”»é¢ä¸­å¤®ã«å¤§ããã€å¤ªãæ›¸ã„ã¦ãã ã•ã„</div>
                
                <div class="canvas-container">
                    <div class="canvas-wrapper">
                        <canvas id="drawingCanvas" width="400" height="400"></canvas>
                    </div>
                </div>

                <!-- å‡¦ç†ä¸­è¡¨ç¤º -->
                <div id="processingSection" class="processing-section" style="display: none;">
                    <div class="spinner"></div>
                    <span id="processingText">é«˜ç²¾åº¦OCRã§æ–‡å­—ã‚’èªè­˜ä¸­...</span>
                </div>

                <!-- èªè­˜å€™è£œè¡¨ç¤º -->
                <div id="candidatesSection" class="recognition-candidates" style="display: none;">
                    <h4>èªè­˜å€™è£œï¼ˆæ­£ã—ã„æ–‡å­—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ï¼‰</h4>
                    <div id="candidateButtons"></div>
                </div>

                <!-- çµæœè¡¨ç¤º -->
                <div id="resultSection" class="result-section" style="display: none;">
                    <div id="resultFeedback" class="result-feedback"></div>
                    <div id="resultAnswer" class="result-answer"></div>
                </div>

                <!-- ãƒœã‚¿ãƒ³ -->
                <div class="buttons">
                    <button id="clearBtn" class="btn btn-clear">
                        ğŸ”„ ã‚¯ãƒªã‚¢
                    </button>
                    <button id="checkBtn" class="btn btn-check">
                        âœ“ åˆ¤å®š
                    </button>
                    <button id="nextBtn" class="btn btn-next" style="display: none;">
                        â¡ï¸ æ¬¡ã¸
                    </button>
                </div>
            </div>

            <!-- ä½¿ç”¨èª¬æ˜ -->
            <div class="tips">
                <h4>ğŸ“ æ›¸ãæ–¹ã®ã‚³ãƒ„ï¼ˆé«˜ç²¾åº¦OCRå¯¾å¿œï¼‰</h4>
                <ul>
                    <li>1æ–‡å­—ã ã‘ç”»é¢ä¸­å¤®ã«å¤§ããæ›¸ã„ã¦ãã ã•ã„</li>
                    <li>ç·šã¯å¤ªãã€ã¯ã£ãã‚Šã¨æ›¸ã„ã¦ãã ã•ã„</li>
                    <li>ç”»æ•°ã‚„æ–‡å­—ã®å½¢ã‚’æ­£ç¢ºã«æ›¸ã„ã¦ãã ã•ã„</li>
                    <li>è¤‡æ•°ã®OCRã‚¨ãƒ³ã‚¸ãƒ³ã§è‡ªå‹•èªè­˜ã—ã¾ã™</li>
                    <li>èªè­˜ãŒã†ã¾ãã„ã‹ãªã„å ´åˆã¯å€™è£œã‹ã‚‰é¸æŠã§ãã¾ã™</li>
                </ul>
            </div>

            <!-- ãƒœã‚¿ãƒ³ç¾¤ -->
            <div style="text-align: center; padding: 20px;">
                <button id="resetBtn" class="btn btn-reset">
                    ğŸ”„ ãƒ†ã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                </button>
                <button id="gradeSelectBtn" class="btn btn-grade">
                    ğŸ“š å­¦å¹´é¸æŠã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- Tesseract.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    <!-- OpenCV.js for advanced image preprocessing -->
    <script async src="https://docs.opencv.org/4.5.0/opencv.js"></script>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let canvas, ctx;
        let isDrawing = false;
        let currentQuestionIndex = 0;
        let score = 0;
        let tesseractWorker = null;
        let ocrReady = false;
        let currentGrade = 1;
        let currentQuestions = [];
        let cvReady = false;

        // OCRã‚¨ãƒ³ã‚¸ãƒ³ã®çŠ¶æ…‹ç®¡ç†
        let ocrEngines = {
            tesseract: { ready: false, accuracy: 0.7 },
            googleVision: { ready: false, accuracy: 0.98 },
            userLocal: { ready: false, accuracy: 0.95 }
        };

        // 1æ–‡å­—æ¼¢å­—å•é¡Œãƒ‡ãƒ¼ã‚¿ï¼ˆæ–‡ç« ç©´åŸ‹ã‚å½¢å¼ï¼‰
        const kanjiQuestions = {
            1: [
                { text: "ã‚ãŸã—ã¯æ¯æ—¥<span class='target-kanji'>ãŒã£ã“ã†</span>ã¸è¡Œãã¾ã™ã€‚", target: "ãŒã", answer: "å­¦", hint: "ã€ŒãŒã£ã“ã†ã€ã®ã€ŒãŒãã€ã‚’æ¼¢å­—ã§" },
                { text: "é«˜ã„<span class='target-kanji'>ã‚„ã¾</span>ã«ç™»ã‚Šã¾ã—ãŸã€‚", target: "ã‚„ã¾", answer: "å±±", hint: "ã€Œã‚„ã¾ã€ã‚’æ¼¢å­—ã§" },
                { text: "å†·ãŸã„<span class='target-kanji'>ã¿ãš</span>ã‚’é£²ã¿ã¾ã—ãŸã€‚", target: "ã¿ãš", answer: "æ°´", hint: "ã€Œã¿ãšã€ã‚’æ¼¢å­—ã§" },
                { text: "<span class='target-kanji'>ã²</span>ã‚’ã¤ã‘ã¦æ–™ç†ã‚’ã—ã¾ã™ã€‚", target: "ã²", answer: "ç«", hint: "ã€Œã²ã€ã‚’æ¼¢å­—ã§" },
                { text: "ç•‘ã®<span class='target-kanji'>ã¤ã¡</span>ã‚’æ˜ã‚Šã¾ã—ãŸã€‚", target: "ã¤ã¡", answer: "åœŸ", hint: "ã€Œã¤ã¡ã€ã‚’æ¼¢å­—ã§" },
                { text: "å¤§ããª<span class='target-kanji'>ã</span>ã«é³¥ãŒã¨ã¾ã£ã¦ã„ã¾ã™ã€‚", target: "ã", answer: "æœ¨", hint: "ã€Œãã€ã‚’æ¼¢å­—ã§" },
                { text: "ãŸãã•ã‚“ã®<span class='target-kanji'>ã²ã¨</span>ãŒé›†ã¾ã‚Šã¾ã—ãŸã€‚", target: "ã²ã¨", answer: "äºº", hint: "ã€Œã²ã¨ã€ã‚’æ¼¢å­—ã§" },
                { text: "<span class='target-kanji'>ãŠãŠ</span>ããªçŠ¬ãŒã„ã¾ã™ã€‚", target: "ãŠãŠ", answer: "å¤§", hint: "ã€ŒãŠãŠãã„ã€ã®ã€ŒãŠãŠã€ã‚’æ¼¢å­—ã§" },
                { text: "<span class='target-kanji'>ã¡ã„</span>ã•ãªèŠ±ãŒå’²ã„ã¦ã„ã¾ã™ã€‚", target: "ã¡ã„", answer: "å°", hint: "ã€Œã¡ã„ã•ã„ã€ã®ã€Œã¡ã„ã€ã‚’æ¼¢å­—ã§" },
                { text: "ç®±ã®<span class='target-kanji'>ãªã‹</span>ã«å…¥ã‚Œã¾ã™ã€‚", target: "ãªã‹", answer: "ä¸­", hint: "ã€Œãªã‹ã€ã‚’æ¼¢å­—ã§" },
                { text: "ä»Š<span class='target-kanji'>ã«ã¡</span>ã¯æ™´ã‚Œã¦ã„ã¾ã™ã€‚", target: "ã«ã¡", answer: "æ—¥", hint: "ã€Œã«ã¡ã€ã‚’æ¼¢å­—ã§" },
                { text: "æ¥<span class='target-kanji'>ã¤ã</span>ã¯é‹å‹•ä¼šã§ã™ã€‚", target: "ã¤ã", answer: "æœˆ", hint: "ã€Œã¤ãã€ã‚’æ¼¢å­—ã§" },
                { text: "å»<span class='target-kanji'>ã­ã‚“</span>ã®å†™çœŸã‚’è¦‹ã¾ã—ãŸã€‚", target: "ã­ã‚“", answer: "å¹´", hint: "ã€Œã­ã‚“ã€ã‚’æ¼¢å­—ã§" },
                { text: "3<span class='target-kanji'>ã˜</span>ã«å¸°ã‚Šã¾ã™ã€‚", target: "ã˜", answer: "æ™‚", hint: "ã€Œã˜ã€ã‚’æ¼¢å­—ã§" },
                { text: "10<span class='target-kanji'>ã¶ã‚“</span>å¾…ã£ã¦ãã ã•ã„ã€‚", target: "ã¶ã‚“", answer: "åˆ†", hint: "ã€Œã¶ã‚“ã€ã‚’æ¼¢å­—ã§" }
            ],
            2: [
                { text: "<span class='target-kanji'>ã‚ã</span>ã«ãªã‚‹ã¨è‘‰ãŒèµ¤ããªã‚Šã¾ã™ã€‚", target: "ã‚ã", answer: "ç§‹", hint: "ã€Œã‚ãã€ã‚’æ¼¢å­—ã§" },
                { text: "æ¯<span class='target-kanji'>ã‚ã•</span>æ—©ãèµ·ãã¾ã™ã€‚", target: "ã‚ã•", answer: "æœ", hint: "ã€Œã‚ã•ã€ã‚’æ¼¢å­—ã§" },
                { text: "ä»Šæ—¥ã¯ã¨ã¦ã‚‚<span class='target-kanji'>ã‚ã¤</span>ã„ã§ã™ã€‚", target: "ã‚ã¤", answer: "æš‘", hint: "ã€Œã‚ã¤ã„ã€ã®ã€Œã‚ã¤ã€ã‚’æ¼¢å­—ã§" },
                { text: "ç§ã®<span class='target-kanji'>ã‚ã«</span>ã¯é«˜æ ¡ç”Ÿã§ã™ã€‚", target: "ã‚ã«", answer: "å…„", hint: "ã€Œã‚ã«ã€ã‚’æ¼¢å­—ã§" },
                { text: "ç§ã®<span class='target-kanji'>ã‚ã­</span>ã¯å¤§å­¦ç”Ÿã§ã™ã€‚", target: "ã‚ã­", answer: "å§‰", hint: "ã€Œã‚ã­ã€ã‚’æ¼¢å­—ã§" },
                { text: "ã‹ã‚ã„ã„<span class='target-kanji'>ã„ã‚‚ã†ã¨</span>ãŒã„ã¾ã™ã€‚", target: "ã„ã‚‚ã†ã¨", answer: "å¦¹", hint: "ã€Œã„ã‚‚ã†ã¨ã€ã®ã€Œã„ã‚‚ã†ã€ã‚’æ¼¢å­—ã§" },
                { text: "å…ƒæ°—ãª<span class='target-kanji'>ãŠã¨ã†ã¨</span>ãŒã„ã¾ã™ã€‚", target: "ãŠã¨ã†ã¨", answer: "å¼Ÿ", hint: "ã€ŒãŠã¨ã†ã¨ã€ã®ã€ŒãŠã¨ã†ã€ã‚’æ¼¢å­—ã§" },
                { text: "ç§ã®<span class='target-kanji'>ãŠã‚„</span>ã¯å„ªã—ã„ã§ã™ã€‚", target: "ãŠã‚„", answer: "è¦ª", hint: "ã€ŒãŠã‚„ã€ã‚’æ¼¢å­—ã§" },
                { text: "å°ã•ãª<span class='target-kanji'>ã“</span>ã©ã‚‚ãŒéŠã‚“ã§ã„ã¾ã™ã€‚", target: "ã“", answer: "å­", hint: "ã€Œã“ã©ã‚‚ã€ã®ã€Œã“ã€ã‚’æ¼¢å­—ã§" },
                { text: "<span class='target-kanji'>ã ã‚“</span>ã®å­ãŒèµ°ã£ã¦ã„ã¾ã™ã€‚", target: "ã ã‚“", answer: "ç”·", hint: "ã€Œã ã‚“ã—ã€ã®ã€Œã ã‚“ã€ã‚’æ¼¢å­—ã§" },
                { text: "<span class='target-kanji'>ã˜ã‚‡</span>ã®å­ãŒæ­Œã£ã¦ã„ã¾ã™ã€‚", target: "ã˜ã‚‡", answer: "å¥³", hint: "ã€Œã˜ã‚‡ã—ã€ã®ã€Œã˜ã‚‡ã€ã‚’æ¼¢å­—ã§" },
                { text: "ç§ã®<span class='target-kanji'>ã‚†ã†</span>ã ã¡ã§ã™ã€‚", target: "ã‚†ã†", answer: "å‹", hint: "ã€Œã‚†ã†ã ã¡ã€ã®ã€Œã‚†ã†ã€ã‚’æ¼¢å­—ã§" },
                { text: "ã¿ã‚“ãªã§<span class='target-kanji'>ãªã‹</span>ã‚ˆãéŠã³ã¾ã™ã€‚", target: "ãªã‹", answer: "ä»²", hint: "ã€Œãªã‹ã‚ˆã—ã€ã®ã€Œãªã‹ã€ã‚’æ¼¢å­—ã§" },
                { text: "<span class='target-kanji'>ã¿ãª</span>ã§åŠ›ã‚’åˆã‚ã›ã¾ã™ã€‚", target: "ã¿ãª", answer: "çš†", hint: "ã€Œã¿ã‚“ãªã€ã®ã€Œã¿ãªã€ã‚’æ¼¢å­—ã§" },
                { text: "<span class='target-kanji'>ã˜</span>åˆ†ã§è€ƒãˆã¾ã™ã€‚", target: "ã˜", answer: "è‡ª", hint: "ã€Œã˜ã¶ã‚“ã€ã®ã€Œã˜ã€ã‚’æ¼¢å­—ã§" }
            ],
            3: [
                { text: "æˆæ¥­ã®<span class='target-kanji'>ã‚ã„ã </span>ã«ä¼‘æ†©ã—ã¾ã™ã€‚", target: "ã‚ã„ã ", answer: "é–“", hint: "ã€Œã‚ã„ã ã€ã‚’æ¼¢å­—ã§" },
                { text: "ã¿ã‚“ãªã§<span class='target-kanji'>ã—ã‚…ã†</span>ã¾ã‚Šã¾ã—ãŸã€‚", target: "ã—ã‚…ã†", answer: "é›†", hint: "ã€Œã—ã‚…ã†ã¾ã‚‹ã€ã®ã€Œã—ã‚…ã†ã€ã‚’æ¼¢å­—ã§" },
                { text: "æµ·ãŒ<span class='target-kanji'>ã“ã†</span>ã‚Œã¦ã„ã¾ã™ã€‚", target: "ã“ã†", answer: "è’", hint: "ã€Œã‚ã‚‰ã„ã€ã®ã€Œã“ã†ã€ã‚’æ¼¢å­—ã§" },
                { text: "æ·±ã<span class='target-kanji'>ãã</span>ã‚’ã—ã¾ã™ã€‚", target: "ãã", answer: "æ¯", hint: "ã€Œã„ãã€ã®ã€Œããã€ã‚’æ¼¢å­—ã§" },
                { text: "èŠ±ã‚’<span class='target-kanji'>ã„ã</span>ã‘ã¾ã™ã€‚", target: "ã„ã", answer: "ç”Ÿ", hint: "ã€Œã„ã‘ã‚‹ã€ã®ã€Œã„ãã€ã‚’æ¼¢å­—ã§" },
                { text: "å³<span class='target-kanji'>ã‚ã‚“</span>ã‚’ä¸Šã’ã¾ã™ã€‚", target: "ã‚ã‚“", answer: "è…•", hint: "ã€Œã†ã§ã€ã®ã€Œã‚ã‚“ã€ã‚’æ¼¢å­—ã§" },
                { text: "æœ¬ã®<span class='target-kanji'>ã†ã‚‰</span>ã‚’è¦‹ã¾ã™ã€‚", target: "ã†ã‚‰", answer: "è£", hint: "ã€Œã†ã‚‰ã€ã‚’æ¼¢å­—ã§" },
                { text: "é›»è»Šã®<span class='target-kanji'>ãˆã</span>ã§å¾…ã¡ã¾ã™ã€‚", target: "ãˆã", answer: "é§…", hint: "ã€Œãˆãã€ã‚’æ¼¢å­—ã§" },
                { text: "ä¸€<span class='target-kanji'>ãŠã</span>å††ã§ã™ã€‚", target: "ãŠã", answer: "å„„", hint: "ã€ŒãŠãã€ã‚’æ¼¢å­—ã§" },
                { text: "<span class='target-kanji'>ãŠã‚“</span>åº¦ã‚’æ¸¬ã‚Šã¾ã™ã€‚", target: "ãŠã‚“", answer: "æ¸©", hint: "ã€ŒãŠã‚“ã©ã€ã®ã€ŒãŠã‚“ã€ã‚’æ¼¢å­—ã§" },
                { text: "äºŒ<span class='target-kanji'>ã‹ã„</span>ã«ä¸ŠãŒã‚Šã¾ã™ã€‚", target: "ã‹ã„", answer: "éš", hint: "ã€Œã‹ã„ã€ã‚’æ¼¢å­—ã§" },
                { text: "<span class='target-kanji'>ã‹</span>å­¦ã®å®Ÿé¨“ã‚’ã—ã¾ã™ã€‚", target: "ã‹", answer: "ç§‘", hint: "ã€Œã‹ãŒãã€ã®ã€Œã‹ã€ã‚’æ¼¢å­—ã§" },
                { text: "ã©ã¡ã‚‰ã®<span class='target-kanji'>ã»ã†</span>ã§ã™ã‹ã€‚", target: "ã»ã†", answer: "æ–¹", hint: "ã€Œã»ã†ã€ã‚’æ¼¢å­—ã§" },
                { text: "ä¸‰<span class='target-kanji'>ã‹ã</span>å½¢ã‚’æãã¾ã™ã€‚", target: "ã‹ã", answer: "è§’", hint: "ã€Œã‹ãã€ã‚’æ¼¢å­—ã§" },
                { text: "ãŠå¯ºã®<span class='target-kanji'>ã—ã‚‡ã†</span>ãŒé³´ã‚Šã¾ã™ã€‚", target: "ã—ã‚‡ã†", answer: "é˜", hint: "ã€Œã‹ã­ã€ã®ã€Œã—ã‚‡ã†ã€ã‚’æ¼¢å­—ã§" }
            ],
            4: [
                { text: "å®¶æ—ã¸ã®<span class='target-kanji'>ã‚ã„</span>ã‚’æ„Ÿã˜ã¾ã™ã€‚", target: "ã‚ã„", answer: "æ„›", hint: "ã€Œã‚ã„ã€ã‚’æ¼¢å­—ã§" },
                { text: "<span class='target-kanji'>ã‚ã</span>ã„è¡Œã„ã¯ã„ã‘ã¾ã›ã‚“ã€‚", target: "ã‚ã", answer: "æ‚ª", hint: "ã€Œã‚ã‚‹ã„ã€ã®ã€Œã‚ãã€ã‚’æ¼¢å­—ã§" },
                { text: "å¼·ã„<span class='target-kanji'>ã‚ã¤</span>åŠ›ãŒã‹ã‹ã‚Šã¾ã™ã€‚", target: "ã‚ã¤", answer: "åœ§", hint: "ã€Œã‚ã¤ã‚Šã‚‡ãã€ã®ã€Œã‚ã¤ã€ã‚’æ¼¢å­—ã§" },
                { text: "ã¿ã‚“ãªã§<span class='target-kanji'>ã„</span>ã¿ã¾ã™ã€‚", target: "ã„", answer: "å›²", hint: "ã€Œã‹ã“ã‚€ã€ã®ã€Œã„ã€ã‚’æ¼¢å­—ã§" },
                { text: "å¤§åˆ‡ãª<span class='target-kanji'>ã„ã‚“</span>ã‚’æŠ¼ã—ã¾ã™ã€‚", target: "ã„ã‚“", answer: "å°", hint: "ã€Œã¯ã‚“ã“ã€ã®ã€Œã„ã‚“ã€ã‚’æ¼¢å­—ã§" },
                { text: "<span class='target-kanji'>ãˆã„</span>èªã‚’å‹‰å¼·ã—ã¾ã™ã€‚", target: "ãˆã„", answer: "è‹±", hint: "ã€Œãˆã„ã”ã€ã®ã€Œãˆã„ã€ã‚’æ¼¢å­—ã§" },
                { text: "æ°´ã®<span class='target-kanji'>ãˆã</span>ä½“ã§ã™ã€‚", target: "ãˆã", answer: "æ¶²", hint: "ã€ŒãˆããŸã„ã€ã®ã€Œãˆãã€ã‚’æ¼¢å­—ã§" },
                { text: "éŸ³æ¥½ã‚’<span class='target-kanji'>ãˆã‚“</span>å¥ã—ã¾ã™ã€‚", target: "ãˆã‚“", answer: "æ¼”", hint: "ã€Œãˆã‚“ãã†ã€ã®ã€Œãˆã‚“ã€ã‚’æ¼¢å­—ã§" },
                { text: "æ˜”ã®<span class='target-kanji'>ãŠã†</span>æ§˜ã§ã™ã€‚", target: "ãŠã†", answer: "ç‹", hint: "ã€ŒãŠã†ã•ã¾ã€ã®ã€ŒãŠã†ã€ã‚’æ¼¢å­—ã§" },
                { text: "éƒ¨å±‹ã®<span class='target-kanji'>ãŠã</span>ã«ã‚ã‚Šã¾ã™ã€‚", target: "ãŠã", answer: "å¥¥", hint: "ã€ŒãŠãã€ã‚’æ¼¢å­—ã§" },
                { text: "å…ˆç”Ÿã®<span class='target-kanji'>ãŠã‚“</span>ã‚’å¿˜ã‚Œã¾ã›ã‚“ã€‚", target: "ãŠã‚“", answer: "æ©", hint: "ã€ŒãŠã‚“ã€ã‚’æ¼¢å­—ã§" },
                { text: "ç ‚ç³–ã‚’<span class='target-kanji'>ã‹</span>ãˆã¾ã™ã€‚", target: "ã‹", answer: "åŠ ", hint: "ã€Œãã‚ãˆã‚‹ã€ã®ã€Œã‹ã€ã‚’æ¼¢å­—ã§" },
                { text: "ãƒ«ãƒ¼ãƒ«ã‚’<span class='target-kanji'>ã‹ã„</span>ã‚ã¾ã™ã€‚", target: "ã‹ã„", answer: "æ”¹", hint: "ã€Œã‚ã‚‰ãŸã‚ã‚‹ã€ã®ã€Œã‹ã„ã€ã‚’æ¼¢å­—ã§" },
                { text: "<span class='target-kanji'>ã‹ã</span>ã‚¯ãƒ©ã‚¹ã‹ã‚‰ä»£è¡¨ãŒå‡ºã¾ã™ã€‚", target: "ã‹ã", answer: "å„", hint: "ã€Œã‹ãã€ã‚’æ¼¢å­—ã§" },
                { text: "å‹é”ã¨<span class='target-kanji'>ã‹ã‚“</span>ä¿‚ãŒã‚ã‚Šã¾ã™ã€‚", target: "ã‹ã‚“", answer: "é–¢", hint: "ã€Œã‹ã‚“ã‘ã„ã€ã®ã€Œã‹ã‚“ã€ã‚’æ¼¢å­—ã§" }
            ],
            5: [
                { text: "å¼·ã„<span class='target-kanji'>ã‚ã¤</span>åŠ›ã‚’æ„Ÿã˜ã¾ã™ã€‚", target: "ã‚ã¤", answer: "åœ§", hint: "ã€Œã‚ã¤ã‚Šã‚‡ãã€ã®ã€Œã‚ã¤ã€ã‚’æ¼¢å­—ã§" },
                { text: "åˆ¥ã®å ´æ‰€ã«<span class='target-kanji'>ã„</span>å‹•ã—ã¾ã™ã€‚", target: "ã„", answer: "ç§»", hint: "ã€Œã„ã©ã†ã€ã®ã€Œã„ã€ã‚’æ¼¢å­—ã§" },
                { text: "äº‹æ•…ã®<span class='target-kanji'>ã„ã‚“</span>ã‚’èª¿ã¹ã¾ã™ã€‚", target: "ã„ã‚“", answer: "å› ", hint: "ã€Œã’ã‚“ã„ã‚“ã€ã®ã€Œã„ã‚“ã€ã‚’æ¼¢å­—ã§" },
                { text: "<span class='target-kanji'>ãˆã„</span>é ã«ç¶šãã¾ã™ã€‚", target: "ãˆã„", answer: "æ°¸", hint: "ã€Œãˆã„ãˆã‚“ã€ã®ã€Œãˆã„ã€ã‚’æ¼¢å­—ã§" },
                { text: "ãŠåº—ã‚’<span class='target-kanji'>ãˆã„</span>æ¥­ã—ã¾ã™ã€‚", target: "ãˆã„", answer: "å–¶", hint: "ã€Œãˆã„ãã‚‡ã†ã€ã®ã€Œãˆã„ã€ã‚’æ¼¢å­—ã§" },
                { text: "<span class='target-kanji'>ãˆã„</span>ç”Ÿã«æ°—ã‚’ã¤ã‘ã¾ã™ã€‚", target: "ãˆã„", answer: "è¡›", hint: "ã€Œãˆã„ã›ã„ã€ã®ã€Œãˆã„ã€ã‚’æ¼¢å­—ã§" },
                { text: "å•é¡ŒãŒ<span class='target-kanji'>ãˆã</span>ã—ã„ã§ã™ã€‚", target: "ãˆã", answer: "æ˜“", hint: "ã€Œã‚„ã•ã—ã„ã€ã®ã€Œãˆãã€ã‚’æ¼¢å­—ã§" },
                { text: "ä¼šç¤¾ã®<span class='target-kanji'>ãˆã</span>ã«ãªã‚Šã¾ã™ã€‚", target: "ãˆã", answer: "ç›Š", hint: "ã€Œã‚Šãˆãã€ã®ã€Œãˆãã€ã‚’æ¼¢å­—ã§" },
                { text: "åŠ‡ã‚’<span class='target-kanji'>ãˆã‚“</span>ã˜ã¾ã™ã€‚", target: "ãˆã‚“", answer: "æ¼”", hint: "ã€Œãˆã‚“ã˜ã‚‹ã€ã®ã€Œãˆã‚“ã€ã‚’æ¼¢å­—ã§" },
                { text: "è³ªå•ã«<span class='target-kanji'>ãŠã†</span>ç­”ã—ã¾ã™ã€‚", target: "ãŠã†", answer: "å¿œ", hint: "ã€ŒãŠã†ã¨ã†ã€ã®ã€ŒãŠã†ã€ã‚’æ¼¢å­—ã§" },
                { text: "<span class='target-kanji'>ãŠã†</span>å¾©åˆ‡ç¬¦ã‚’è²·ã„ã¾ã™ã€‚", target: "ãŠã†", answer: "å¾€", hint: "ã€ŒãŠã†ãµãã€ã®ã€ŒãŠã†ã€ã‚’æ¼¢å­—ã§" },
                { text: "å…ˆç”Ÿã®<span class='target-kanji'>ãŠã‚“</span>æµã‚’å—ã‘ã¾ã™ã€‚", target: "ãŠã‚“", answer: "æ©", hint: "ã€ŒãŠã‚“ã‘ã„ã€ã®ã€ŒãŠã‚“ã€ã‚’æ¼¢å­—ã§" },
                { text: "å®Ÿç¾ãŒ<span class='target-kanji'>ã‹</span>èƒ½ã§ã™ã€‚", target: "ã‹", answer: "å¯", hint: "ã€Œã‹ã®ã†ã€ã®ã€Œã‹ã€ã‚’æ¼¢å­—ã§" },
                { text: "<span class='target-kanji'>ã‹</span>å®šã®è©±ã‚’ã—ã¾ã™ã€‚", target: "ã‹", answer: "ä»®", hint: "ã€Œã‹ã¦ã„ã€ã®ã€Œã‹ã€ã‚’æ¼¢å­—ã§" },
                { text: "å•†å“ã®<span class='target-kanji'>ã‹</span>æ ¼ã‚’èª¿ã¹ã¾ã™ã€‚", target: "ã‹", answer: "ä¾¡", hint: "ã€Œã‹ã‹ãã€ã®ã€Œã‹ã€ã‚’æ¼¢å­—ã§" }
            ],
            6: [
                { text: "ä»–ã¨ã¯<span class='target-kanji'>ã„</span>ãªã‚‹æ„è¦‹ã§ã™ã€‚", target: "ã„", answer: "ç•°", hint: "ã€Œã“ã¨ãªã‚‹ã€ã®ã€Œã„ã€ã‚’æ¼¢å­—ã§" },
                { text: "æ–‡åŒ–<span class='target-kanji'>ã„</span>ç”£ã‚’å®ˆã‚Šã¾ã™ã€‚", target: "ã„", answer: "éº", hint: "ã€Œã„ã•ã‚“ã€ã®ã€Œã„ã€ã‚’æ¼¢å­—ã§" },
                { text: "ã“ã®åœ°<span class='target-kanji'>ã„ã</span>ã¯é™ã‹ã§ã™ã€‚", target: "ã„ã", answer: "åŸŸ", hint: "ã€Œã¡ã„ãã€ã®ã€Œã„ãã€ã‚’æ¼¢å­—ã§" },
                { text: "<span class='target-kanji'>ã†</span>å®™ã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚", target: "ã†", answer: "å®‡", hint: "ã€Œã†ã¡ã‚…ã†ã€ã®ã€Œã†ã€ã‚’æ¼¢å­—ã§" },
                { text: "é¢ç™½ã„<span class='target-kanji'>ãˆã„</span>ç”»ã‚’è¦‹ã¾ã—ãŸã€‚", target: "ãˆã„", answer: "æ˜ ", hint: "ã€Œãˆã„ãŒã€ã®ã€Œãˆã„ã€ã‚’æ¼¢å­—ã§" },
                { text: "æ™‚é–“ã‚’<span class='target-kanji'>ãˆã‚“</span>é•·ã—ã¾ã™ã€‚", target: "ãˆã‚“", answer: "å»¶", hint: "ã€Œãˆã‚“ã¡ã‚‡ã†ã€ã®ã€Œãˆã‚“ã€ã‚’æ¼¢å­—ã§" },
                { text: "<span class='target-kanji'>ãŒ</span>ã€…ã®æ„è¦‹ã‚’èãã¾ã™ã€‚", target: "ãŒ", answer: "æˆ‘", hint: "ã€Œã‚ã‚Œã‚ã‚Œã€ã®ã€ŒãŒã€ã‚’æ¼¢å­—ã§" },
                { text: "ç«å±±ã®<span class='target-kanji'>ã¯ã„</span>ãŒé™ã‚Šã¾ã™ã€‚", target: "ã¯ã„", answer: "ç°", hint: "ã€Œã¯ã„ã€ã‚’æ¼¢å­—ã§" },
                { text: "äº‹æ¥­ã‚’<span class='target-kanji'>ã‹ã</span>å¤§ã—ã¾ã™ã€‚", target: "ã‹ã", answer: "æ‹¡", hint: "ã€Œã‹ãã ã„ã€ã®ã€Œã‹ãã€ã‚’æ¼¢å­—ã§" },
                { text: "ç¤¾ä¼š<span class='target-kanji'>ã‹ã</span>å‘½ãŒèµ·ã“ã‚Šã¾ã™ã€‚", target: "ã‹ã", answer: "é©", hint: "ã€Œã‹ãã‚ã„ã€ã®ã€Œã‹ãã€ã‚’æ¼¢å­—ã§" },
                { text: "å†…<span class='target-kanji'>ã‹ã</span>ã®ä¼šè­°ã§ã™ã€‚", target: "ã‹ã", answer: "é–£", hint: "ã€Œãªã„ã‹ãã€ã®ã€Œã‹ãã€ã‚’æ¼¢å­—ã§" },
                { text: "åŠåˆ†ã«<span class='target-kanji'>ã‚ã‚Š</span>ã¾ã™ã€‚", target: "ã‚ã‚Š", answer: "å‰²", hint: "ã€Œã‚ã‚‹ã€ã®ã€Œã‚ã‚Šã€ã‚’æ¼¢å­—ã§" },
                { text: "ä¼šç¤¾ã®<span class='target-kanji'>ã‹ã¶</span>ã‚’è²·ã„ã¾ã™ã€‚", target: "ã‹ã¶", answer: "æ ª", hint: "ã€Œã‹ã¶ã€ã‚’æ¼¢å­—ã§" },
                { text: "æ´—æ¿¯ç‰©ã‚’<span class='target-kanji'>ã‹ã‚“</span>ã—ã¾ã™ã€‚", target: "ã‹ã‚“", answer: "å¹²", hint: "ã€Œã»ã™ã€ã®ã€Œã‹ã‚“ã€ã‚’æ¼¢å­—ã§" },
                { text: "æœ¬ã‚’<span class='target-kanji'>ã‹ã‚“</span>ãã¾ã™ã€‚", target: "ã‹ã‚“", answer: "å·»", hint: "ã€Œã¾ãã€ã®ã€Œã‹ã‚“ã€ã‚’æ¼¢å­—ã§" }
            ]
        };

        // DOMè¦ç´ 
        const elements = {
            canvas: null,
            currentQuestion: null,
            totalQuestions: null,
            currentScore: null,
            questionText: null,
            questionHint: null,
            gradeInfo: null,
            initStatus: null,
            ocrEngineStatus: null,
            processingSection: null,
            processingText: null,
            candidatesSection: null,
            candidateButtons: null,
            resultSection: null,
            resultFeedback: null,
            resultAnswer: null,
            clearBtn: null,
            checkBtn: null,
            nextBtn: null,
            resetBtn: null,
            gradeSelectBtn: null,
            gradeSelectionScreen: null,
            gameScreen: null
        };

        // OpenCV.js èª­ã¿è¾¼ã¿å®Œäº†ãƒã‚§ãƒƒã‚¯
        function onOpenCvReady() {
            cvReady = true;
            console.log('OpenCV.js is ready.');
            updateOCREngineStatus();
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeElements();
            initializeCanvas();
            initializeTesseract();
            initializeUserLocalOCR();
            setupEventListeners();
            
            // OpenCV.js ã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
            if (typeof cv !== 'undefined') {
                onOpenCvReady();
            } else {
                setTimeout(() => {
                    if (typeof cv !== 'undefined') {
                        onOpenCvReady();
                    }
                }, 1000);
            }
        });

        // DOMè¦ç´ ã®å–å¾—
        function initializeElements() {
            elements.canvas = document.getElementById('drawingCanvas');
            elements.currentQuestion = document.getElementById('currentQuestion');
            elements.totalQuestions = document.getElementById('totalQuestions');
            elements.currentScore = document.getElementById('currentScore');
            elements.questionText = document.getElementById('questionText');
            elements.questionHint = document.getElementById('questionHint');
            elements.gradeInfo = document.getElementById('gradeInfo');
            elements.initStatus = document.getElementById('initStatus');
            elements.ocrEngineStatus = document.getElementById('ocrEngineStatus');
            elements.processingSection = document.getElementById('processingSection');
            elements.processingText = document.getElementById('processingText');
            elements.candidatesSection = document.getElementById('candidatesSection');
            elements.candidateButtons = document.getElementById('candidateButtons');
            elements.resultSection = document.getElementById('resultSection');
            elements.resultFeedback = document.getElementById('resultFeedback');
            elements.resultAnswer = document.getElementById('resultAnswer');
            elements.clearBtn = document.getElementById('clearBtn');
            elements.checkBtn = document.getElementById('checkBtn');
            elements.nextBtn = document.getElementById('nextBtn');
            elements.resetBtn = document.getElementById('resetBtn');
            elements.gradeSelectBtn = document.getElementById('gradeSelectBtn');
            elements.gradeSelectionScreen = document.getElementById('gradeSelectionScreen');
            elements.gameScreen = document.getElementById('gameScreen');

            canvas = elements.canvas;
            ctx = canvas.getContext('2d');
        }

        // OCRã‚¨ãƒ³ã‚¸ãƒ³çŠ¶æ…‹æ›´æ–°
        function updateOCREngineStatus() {
            const readyEngines = Object.keys(ocrEngines).filter(engine => ocrEngines[engine].ready);
            const totalEngines = Object.keys(ocrEngines).length;
            
            if (readyEngines.length === 0) {
                elements.ocrEngineStatus.innerHTML = 'ğŸ”„ OCRã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–ä¸­...';
                elements.ocrEngineStatus.style.display = 'block';
            } else if (readyEngines.length === totalEngines) {
                elements.ocrEngineStatus.innerHTML = `âœ… é«˜ç²¾åº¦OCRæº–å‚™å®Œäº† (${readyEngines.length}/${totalEngines}ã‚¨ãƒ³ã‚¸ãƒ³)`;
                elements.ocrEngineStatus.style.display = 'block';
                setTimeout(() => {
                    elements.ocrEngineStatus.style.display = 'none';
                }, 3000);
            } else {
                elements.ocrEngineStatus.innerHTML = `âš¡ OCRã‚¨ãƒ³ã‚¸ãƒ³æº–å‚™ä¸­ (${readyEngines.length}/${totalEngines}ã‚¨ãƒ³ã‚¸ãƒ³)`;
                elements.ocrEngineStatus.style.display = 'block';
            }
        }

        // å­¦å¹´é¸æŠ
        function selectGrade(grade) {
            currentGrade = grade;
            
            if (grade === 0) {
                // å…¨å­¦å¹´ã®å ´åˆ
                const allQuestions = Object.values(kanjiQuestions).flat();
                currentQuestions = shuffleArray(allQuestions).slice(0, 20);
            } else {
                // ç‰¹å®šå­¦å¹´ã®å ´åˆ
                currentQuestions = shuffleArray([...kanjiQuestions[grade]]).slice(0, 10);
            }
            
            currentQuestionIndex = 0;
            score = 0;
            
            // å­¦å¹´ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.grade-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (grade === 0) {
                document.querySelectorAll('.grade-btn')[6].classList.add('active');
            } else {
                document.querySelectorAll('.grade-btn')[grade - 1].classList.add('active');
            }
            
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            elements.gradeSelectionScreen.style.display = 'none';
            elements.gameScreen.style.display = 'block';
            
            clearCanvas();
            updateDisplay();
            hideResult();
            
            // OCRæ–‡å­—ãƒªã‚¹ãƒˆæ›´æ–°
            updateOCRWhitelist();
        }

        // å­¦å¹´é¸æŠç”»é¢ã«æˆ»ã‚‹
        function backToGradeSelection() {
            elements.gradeSelectionScreen.style.display = 'block';
            elements.gameScreen.style.display = 'none';
        }

        // é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // OCRæ–‡å­—ãƒªã‚¹ãƒˆæ›´æ–°
        function updateOCRWhitelist() {
            if (!tesseractWorker || !ocrEngines.tesseract.ready) return;
            
            let targetKanji = '';
            if (currentGrade === 0) {
                // å…¨å­¦å¹´ã®å ´åˆ
                targetKanji = Object.values(kanjiQuestions).flat().map(q => q.answer).join('');
            } else {
                // ç‰¹å®šå­¦å¹´ã®å ´åˆ
                targetKanji = kanjiQuestions[currentGrade].map(q => q.answer).join('');
            }
            
            tesseractWorker.setParameters({
                tessedit_char_whitelist: targetKanji,
                tessedit_pageseg_mode: Tesseract.PSM.SINGLE_CHAR,
            });
        }

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®åˆæœŸåŒ–
        function initializeCanvas() {
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 10; // ã‚ˆã‚Šå¤ªã„ç·š
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            clearCanvas();
        }

        // Tesseract.jsã®åˆæœŸåŒ–
        async function initializeTesseract() {
            try {
                showInitStatus('Tesseract OCRã‚¨ãƒ³ã‚¸ãƒ³ã‚’åˆæœŸåŒ–ä¸­...', 'loading');
                
                tesseractWorker = await Tesseract.createWorker({
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            showInitStatus(`Tesseractèªè­˜ä¸­: ${Math.round(m.progress * 100)}%`, 'loading');
                        }
                    }
                });

                showInitStatus('Tesseractè¨€èªãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'loading');
                await tesseractWorker.loadLanguage('jpn+chi_sim');
                
                showInitStatus('TesseractOCRã‚¨ãƒ³ã‚¸ãƒ³ã‚’åˆæœŸåŒ–ä¸­...', 'loading');
                await tesseractWorker.initialize('jpn+chi_sim');
                
                // åˆæœŸè¨­å®šï¼ˆå…¨æ¼¢å­—ï¼‰
                const allKanji = Object.values(kanjiQuestions).flat().map(q => q.answer).join('');
                await tesseractWorker.setParameters({
                    tessedit_char_whitelist: allKanji,
                    tessedit_pageseg_mode: Tesseract.PSM.SINGLE_CHAR,
                    tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY,
                });

                ocrEngines.tesseract.ready = true;
                showInitStatus('âœ“ Tesseract OCRæº–å‚™å®Œäº†', 'ready');
                updateOCREngineStatus();
                
                setTimeout(() => {
                    elements.initStatus.style.display = 'none';
                }, 2000);

            } catch (error) {
                console.error('TesseractåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showInitStatus(`âŒ TesseractåˆæœŸåŒ–å¤±æ•—: ${error.message}`, 'error');
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ã‚«ãƒ«æ‰‹æ›¸ãOCRåˆæœŸåŒ–
        async function initializeUserLocalOCR() {
            try {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ã‚«ãƒ«APIã®åˆ©ç”¨å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
                const testResponse = await fetch('https://ai-ocr.userlocal.jp/api/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                    })
                });
                
                if (testResponse.ok) {
                    ocrEngines.userLocal.ready = true;
                    console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ã‚«ãƒ«æ‰‹æ›¸ãOCRæº–å‚™å®Œäº†');
                } else {
                    console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ã‚«ãƒ«æ‰‹æ›¸ãOCRåˆ©ç”¨ä¸å¯');
                }
            } catch (error) {
                console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ã‚«ãƒ«æ‰‹æ›¸ãOCRæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
            }
            updateOCREngineStatus();
        }

        // åˆæœŸåŒ–çŠ¶æ…‹ã®è¡¨ç¤º
        function showInitStatus(message, type) {
            elements.initStatus.textContent = message;
            elements.initStatus.className = `init-status init-${type}`;
            elements.initStatus.style.display = 'block';
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function setupEventListeners() {
            // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', handleTouchEnd);

            // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            elements.clearBtn.addEventListener('click', clearCanvas);
            elements.checkBtn.addEventListener('click', checkAnswer);
            elements.nextBtn.addEventListener('click', nextQuestion);
            elements.resetBtn.addEventListener('click', resetTest);
            elements.gradeSelectBtn.addEventListener('click', backToGradeSelection);
        }

        // æç”»é–‹å§‹
        function startDrawing(e) {
            isDrawing = true;
            const coords = getCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(coords.x, coords.y);
        }

        // æç”»
        function draw(e) {
            if (!isDrawing) return;
            const coords = getCoordinates(e);
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();
        }

        // æç”»çµ‚äº†
        function stopDrawing() {
            isDrawing = false;
        }

        // åº§æ¨™å–å¾—
        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = {
                clientX: touch.clientX,
                clientY: touch.clientY
            };
            startDrawing(mouseEvent);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = {
                clientX: touch.clientX,
                clientY: touch.clientY
            };
            draw(mouseEvent);
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            stopDrawing();
        }

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªã‚¢
        function clearCanvas() {
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            hideResult();
            hideCandidates();
        }

        // æç”»ãƒã‚§ãƒƒã‚¯
        function hasDrawing() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                if (r < 250 || g < 250 || b < 250) {
                    return true;
                }
            }
            return false;
        }

        // è¶…é«˜ç²¾åº¦ç”»åƒå‰å‡¦ç†ï¼ˆOpenCV.js + è¤‡æ•°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼‰
        function preprocessCanvasUltraHigh(canvas) {
            if (!cvReady) {
                return preprocessCanvasAdvanced(canvas);
            }

            try {
                // OpenCV.jsã‚’ä½¿ç”¨ã—ãŸè¶…é«˜ç²¾åº¦å‰å‡¦ç†
                const src = cv.imread(canvas);
                const gray = new cv.Mat();
                const denoised = new cv.Mat();
                const binary = new cv.Mat();
                const morphed = new cv.Mat();
                const result = new cv.Mat();

                // ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

                // 1. ãƒã‚¤ã‚ºé™¤å»ï¼ˆNon-local Means Denoisingï¼‰
                cv.fastNlMeansDenoising(gray, denoised, 10, 7, 21);

                // 2. ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·åŒ–ï¼ˆCLAHE - Contrast Limited Adaptive Histogram Equalizationï¼‰
                const clahe = cv.createCLAHE(3.0, new cv.Size(8, 8));
                clahe.apply(denoised, denoised);

                                // 3. ã‚·ãƒ£ãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°
                const kernel = cv.matFromArray(3, 3, cv.CV_32FC1, [0, -1, 0, -1, 5, -1, 0, -1, 0]);
                cv.filter2D(denoised, denoised, cv.CV_8U, kernel);

                // 4. é©å¿œçš„äºŒå€¤åŒ–ï¼ˆè¤‡æ•°æ‰‹æ³•ã®çµ„ã¿åˆã‚ã›ï¼‰
                cv.adaptiveThreshold(denoised, binary, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 15, 2);

                // 5. ãƒ¢ãƒ«ãƒ•ã‚©ãƒ­ã‚¸ãƒ¼æ¼”ç®—ï¼ˆãƒã‚¤ã‚ºé™¤å»ã¨æ–‡å­—ã®è£œå¼·ï¼‰
                const morphKernel = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(3, 3));
                cv.morphologyEx(binary, morphed, cv.MORPH_CLOSE, morphKernel);
                cv.morphologyEx(morphed, morphed, cv.MORPH_OPEN, morphKernel);

                // 6. è¼ªéƒ­æ¤œå‡ºã¨ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹æŠ½å‡º
                const contours = new cv.MatVector();
                const hierarchy = new cv.Mat();
                cv.findContours(morphed, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

                if (contours.size() > 0) {
                    // æœ€å¤§ã®è¼ªéƒ­ã‚’è¦‹ã¤ã‘ã‚‹ï¼ˆæ–‡å­—é ˜åŸŸã¨ä»®å®šï¼‰
                    let maxArea = 0;
                    let maxContourIndex = 0;
                    for (let i = 0; i < contours.size(); i++) {
                        const area = cv.contourArea(contours.get(i));
                        if (area > maxArea && area > 100) { // æœ€å°é¢ç©ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                            maxArea = area;
                            maxContourIndex = i;
                        }
                    }

                    if (maxArea > 0) {
                        // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’å–å¾—
                        const rect = cv.boundingRect(contours.get(maxContourIndex));
                        
                        // ä½™ç™½ã‚’è¿½åŠ ï¼ˆæ–‡å­—ã®å®Œå…¨æ€§ã‚’ä¿ã¤ãŸã‚ï¼‰
                        const padding = 30;
                        const x = Math.max(0, rect.x - padding);
                        const y = Math.max(0, rect.y - padding);
                        const width = Math.min(morphed.cols - x, rect.width + padding * 2);
                        const height = Math.min(morphed.rows - y, rect.height + padding * 2);

                        // ROIï¼ˆé–¢å¿ƒé ˜åŸŸï¼‰ã‚’åˆ‡ã‚Šå‡ºã—
                        const roi = new cv.Rect(x, y, width, height);
                        const cropped = morphed.roi(roi);

                        // æ­£æ–¹å½¢ã«ãƒªã‚µã‚¤ã‚ºï¼ˆOCRç²¾åº¦å‘ä¸Šã®ãŸã‚ï¼‰
                        const maxSize = Math.max(width, height);
                        const squareSize = Math.max(maxSize, 200); // æœ€å°ã‚µã‚¤ã‚ºä¿è¨¼
                        const square = new cv.Mat(squareSize, squareSize, cv.CV_8UC1, new cv.Scalar(255));
                        
                        // ä¸­å¤®é…ç½®
                        const offsetX = Math.floor((squareSize - width) / 2);
                        const offsetY = Math.floor((squareSize - height) / 2);
                        
                        cropped.copyTo(square.roi(new cv.Rect(offsetX, offsetY, width, height)));

                        // æœ€çµ‚çš„ã«400x400ã«ãƒªã‚µã‚¤ã‚ºï¼ˆOCRæœ€é©åŒ–ï¼‰
                        cv.resize(square, result, new cv.Size(400, 400), 0, 0, cv.INTER_CUBIC);

                        // æœ€çµ‚çš„ãªã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆèª¿æ•´
                        const alpha = 1.5; // ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆä¿‚æ•°
                        const beta = 10;   // æ˜åº¦èª¿æ•´
                        result.convertTo(result, -1, alpha, beta);

                        // çµæœã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»
                        const resultCanvas = document.createElement('canvas');
                        resultCanvas.width = 400;
                        resultCanvas.height = 400;
                        cv.imshow(resultCanvas, result);

                        // ãƒ¡ãƒ¢ãƒªè§£æ”¾
                        src.delete();
                        gray.delete();
                        denoised.delete();
                        binary.delete();
                        morphed.delete();
                        result.delete();
                        contours.delete();
                        hierarchy.delete();
                        cropped.delete();
                        square.delete();
                        kernel.delete();
                        morphKernel.delete();
                        clahe.delete();

                        return resultCanvas;
                    }
                }

                // è¼ªéƒ­ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
                cv.resize(morphed, result, new cv.Size(400, 400), 0, 0, cv.INTER_CUBIC);
                
                const resultCanvas = document.createElement('canvas');
                resultCanvas.width = 400;
                resultCanvas.height = 400;
                cv.imshow(resultCanvas, result);

                // ãƒ¡ãƒ¢ãƒªè§£æ”¾
                src.delete();
                gray.delete();
                denoised.delete();
                binary.delete();
                morphed.delete();
                result.delete();
                contours.delete();
                hierarchy.delete();
                kernel.delete();
                morphKernel.delete();
                clahe.delete();

                return resultCanvas;

            } catch (error) {
                console.error('OpenCVè¶…é«˜ç²¾åº¦å‰å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                return preprocessCanvasAdvanced(canvas);
            }
        }

        // é«˜åº¦ãªç”»åƒå‰å‡¦ç†ï¼ˆOpenCV.jsä½¿ç”¨ï¼‰
        function preprocessCanvasAdvanced(canvas) {
            if (!cvReady) {
                return preprocessCanvasBasic(canvas);
            }

            try {
                // OpenCV.jsã‚’ä½¿ç”¨ã—ãŸé«˜åº¦ãªå‰å‡¦ç†
                const src = cv.imread(canvas);
                const gray = new cv.Mat();
                const binary = new cv.Mat();
                const morphed = new cv.Mat();
                const result = new cv.Mat();

                // ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

                // ã‚¬ã‚¦ã‚·ã‚¢ãƒ³ãƒ–ãƒ©ãƒ¼ã§ãƒã‚¤ã‚ºé™¤å»
                const ksize = new cv.Size(5, 5);
                cv.GaussianBlur(gray, gray, ksize, 0, 0, cv.BORDER_DEFAULT);

                // é©å¿œçš„äºŒå€¤åŒ–
                cv.adaptiveThreshold(gray, binary, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, 11, 2);

                // ãƒ¢ãƒ«ãƒ•ã‚©ãƒ­ã‚¸ãƒ¼æ¼”ç®—ã§ãƒã‚¤ã‚ºé™¤å»
                const kernel = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(3, 3));
                cv.morphologyEx(binary, morphed, cv.MORPH_CLOSE, kernel);

                // è¼ªéƒ­æ¤œå‡ºã¨ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹
                const contours = new cv.MatVector();
                const hierarchy = new cv.Mat();
                cv.findContours(morphed, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

                if (contours.size() > 0) {
                    // æœ€å¤§ã®è¼ªéƒ­ã‚’è¦‹ã¤ã‘ã‚‹
                    let maxArea = 0;
                    let maxContourIndex = 0;
                    for (let i = 0; i < contours.size(); i++) {
                        const area = cv.contourArea(contours.get(i));
                        if (area > maxArea) {
                            maxArea = area;
                            maxContourIndex = i;
                        }
                    }

                    // ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’å–å¾—
                    const rect = cv.boundingRect(contours.get(maxContourIndex));
                    
                    // ä½™ç™½ã‚’è¿½åŠ 
                    const padding = 20;
                    const x = Math.max(0, rect.x - padding);
                    const y = Math.max(0, rect.y - padding);
                    const width = Math.min(morphed.cols - x, rect.width + padding * 2);
                    const height = Math.min(morphed.rows - y, rect.height + padding * 2);

                    // åˆ‡ã‚Šå‡ºã—
                    const roi = new cv.Rect(x, y, width, height);
                    const cropped = morphed.roi(roi);

                    // æ­£æ–¹å½¢ã«ãƒªã‚µã‚¤ã‚º
                    const size = Math.max(width, height);
                    const square = new cv.Mat(size, size, cv.CV_8UC1, new cv.Scalar(255));
                    const offsetX = Math.floor((size - width) / 2);
                    const offsetY = Math.floor((size - height) / 2);
                    
                    cropped.copyTo(square.roi(new cv.Rect(offsetX, offsetY, width, height)));

                    // æœ€çµ‚çš„ã«300x300ã«ãƒªã‚µã‚¤ã‚º
                    cv.resize(square, result, new cv.Size(300, 300), 0, 0, cv.INTER_CUBIC);

                    // çµæœã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»
                    const resultCanvas = document.createElement('canvas');
                    resultCanvas.width = 300;
                    resultCanvas.height = 300;
                    cv.imshow(resultCanvas, result);

                    // ãƒ¡ãƒ¢ãƒªè§£æ”¾
                    src.delete();
                    gray.delete();
                    binary.delete();
                    morphed.delete();
                    result.delete();
                    contours.delete();
                    hierarchy.delete();
                    cropped.delete();
                    square.delete();
                    kernel.delete();

                    return resultCanvas;
                }

                // ãƒ¡ãƒ¢ãƒªè§£æ”¾
                src.delete();
                gray.delete();
                binary.delete();
                morphed.delete();
                result.delete();
                contours.delete();
                hierarchy.delete();
                kernel.delete();

            } catch (error) {
                console.error('OpenCVå‰å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                return preprocessCanvasBasic(canvas);
            }

            return preprocessCanvasBasic(canvas);
        }

        // åŸºæœ¬çš„ãªç”»åƒå‰å‡¦ç†
        function preprocessCanvasBasic(canvas) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            // æç”»é ˜åŸŸã®æ¤œå‡º
            let minX = canvas.width, maxX = 0, minY = canvas.height, maxY = 0;
            
            for (let y = 0; y < canvas.height; y++) {
                for (let x = 0; x < canvas.width; x++) {
                    const index = (y * canvas.width + x) * 4;
                    const r = data[index];
                    const g = data[index + 1];
                    const b = data[index + 2];
                    
                    if (r < 250 || g < 250 || b < 250) {
                        minX = Math.min(minX, x);
                        maxX = Math.max(maxX, x);
                        minY = Math.min(minY, y);
                        maxY = Math.max(maxY, y);
                    }
                }
            }

            // ä½™ç™½è¿½åŠ 
            const padding = 30;
            minX = Math.max(0, minX - padding);
            maxX = Math.min(canvas.width, maxX + padding);
            minY = Math.max(0, minY - padding);
            maxY = Math.min(canvas.height, maxY + padding);

            // ãƒˆãƒªãƒŸãƒ³ã‚°
            const croppedCanvas = document.createElement('canvas');
            const croppedWidth = maxX - minX;
            const croppedHeight = maxY - minY;
            
            // æ­£æ–¹å½¢ã«ã™ã‚‹
            const size = Math.max(croppedWidth, croppedHeight);
            croppedCanvas.width = size;
            croppedCanvas.height = size;
            
            const croppedCtx = croppedCanvas.getContext('2d');
            croppedCtx.fillStyle = '#ffffff';
            croppedCtx.fillRect(0, 0, size, size);
            
            // ä¸­å¤®ã«é…ç½®
            const offsetX = (size - croppedWidth) / 2;
            const offsetY = (size - croppedHeight) / 2;
            
            croppedCtx.drawImage(
                canvas,
                minX, minY, croppedWidth, croppedHeight,
                offsetX, offsetY, croppedWidth, croppedHeight
            );

            // ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·åŒ–
            const imageData2 = croppedCtx.getImageData(0, 0, size, size);
            const data2 = imageData2.data;
            
            for (let i = 0; i < data2.length; i += 4) {
                const gray = (data2[i] + data2[i + 1] + data2[i + 2]) / 3;
                const binary = gray > 200 ? 255 : 0;
                data2[i] = data2[i + 1] = data2[i + 2] = binary;
            }
            
            croppedCtx.putImageData(imageData2, 0, 0);

            return croppedCanvas;
        }

        // é¡ä¼¼æ¼¢å­—å€™è£œç”Ÿæˆ
        function generateSimilarKanji(targetKanji) {
            const similarKanjiMap = {
                'å­¦': ['å­—', 'å®‰', 'å®‡', 'å®Ÿ'],
                'å±±': ['å·', 'å‡º', 'å²¡', 'å³°'],
                'æ°´': ['æ°·', 'æ°¸', 'æ³³', 'æ±‚'],
                'ç«': ['ç¯', 'ç‚', 'ç½', 'çƒˆ'],
                'åœŸ': ['å£«', 'ç‹', 'å¹²', 'å·¥'],
                'æœ¨': ['æœ¬', 'æ—', 'æ£®', 'æ'],
                'äºº': ['å…¥', 'å…«', 'å¤§', 'å¤©'],
                'å¤§': ['å¤ª', 'çŠ¬', 'å¤©', 'å¤«'],
                'å°': ['å°‘', 'å°–', 'çœ', 'äº¬'],
                'ä¸­': ['å†…', 'ç”³', 'ç”±', 'ç”²'],
                'æ—¥': ['ç›®', 'ç™½', 'ç”°', 'æ—§'],
                'æœˆ': ['ç”¨', 'è‚‰', 'æœ', 'æœ‹'],
                'å¹´': ['åˆ', 'æ‰‹', 'åƒ', 'å¹³'],
                'æ™‚': ['å¯º', 'æŒ', 'å¾…', 'è©©'],
                'åˆ†': ['å…«', 'åˆ€', 'åŠ›', 'å…¬'],
                'ç§‹': ['æ„', 'ç§', 'å’Œ', 'ç§‘'],
                'æœ': ['æ½®', 'å»Ÿ', 'å˜²', 'éŸ“'],
                'æš‘': ['è€…', 'è«¸', 'ç½²', 'éƒ½'],
                'å…„': ['æ³', 'å…‹', 'å…‰', 'å…š'],
                'å§‰': ['å§‹', 'ç´™', 'æŒ‡', 'è„‚'],
                'å¦¹': ['æœª', 'å‘³', 'é­…', 'æ˜§'],
                'å¼Ÿ': ['ç¬¬', 'å¨£', 'é€’', 'æ¢¯'],
                'è¦ª': ['æ–°', 'è–ª', 'è¾›', 'è¿‘'],
                'å­': ['äº†', 'å­”', 'å­—', 'å­˜'],
                'ç”·': ['åŠ›', 'ç”°', 'æ€', 'ç•Œ'],
                'å¥³': ['å®‰', 'å¥½', 'å¦™', 'å¦‚'],
                'å‹': ['æœ‰', 'å³', 'å­˜', 'å'],
                'ä»²': ['ä¸­', 'ä¼¸', 'æ²–', 'å¿ '],
                'çš†': ['éš', 'æ··', 'æ˜”', 'æ—¨'],
                'è‡ª': ['ç™½', 'æ¯', 'ç›®', 'é¦–'],
                'ä»–': ['å¥¹', 'åœ°', 'æ± ', 'ä¹Ÿ']
            };
            
            return similarKanjiMap[targetKanji] || [targetKanji];
        }

        // ç­”ãˆãƒã‚§ãƒƒã‚¯ï¼ˆé«˜ç²¾åº¦OCRå¯¾å¿œï¼‰
        async function checkAnswer() {
            if (!ocrEngines.tesseract.ready) {
                alert('OCRã®æº–å‚™ãŒã§ãã¦ã„ã¾ã›ã‚“ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
                return;
            }

            if (!hasDrawing()) {
                alert('æ¼¢å­—ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚');
                return;
            }

            if (!currentQuestions || currentQuestions.length === 0) {
                alert('å­¦å¹´ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            showProcessing(true);
            hideResult();
            hideCandidates();

            try {
                // è¶…é«˜ç²¾åº¦å‰å‡¦ç†ã‚’é©ç”¨
                const processedCanvas = preprocessCanvasUltraHigh(canvas);
                
                // è¤‡æ•°ã®èªè­˜æ–¹æ³•ã‚’è©¦è¡Œ
                const recognitionResults = [];
                
                // Tesseract.js ã§ã®èªè­˜ï¼ˆè¤‡æ•°è¨­å®šï¼‰
                const configs = [
                    { psm: Tesseract.PSM.SINGLE_CHAR, oem: Tesseract.OEM.LSTM_ONLY },
                    { psm: Tesseract.PSM.SINGLE_BLOCK, oem: Tesseract.OEM.TESSERACT_LSTM_COMBINED },
                    { psm: Tesseract.PSM.SINGLE_WORD, oem: Tesseract.OEM.DEFAULT }
                ];

                for (const config of configs) {
                    try {
                        const result = await tesseractWorker.recognize(processedCanvas, {
                            tessedit_pageseg_mode: config.psm,
                            tessedit_ocr_engine_mode: config.oem
                        });
                        
                        const cleanedText = result.data.text.trim().replace(/\s+/g, '').replace(/[^\u4e00-\u9faf]/g, '');
                        if (cleanedText && cleanedText.length === 1) {
                            recognitionResults.push({
                                text: cleanedText,
                                confidence: result.data.confidence
                            });
                        }
                    } catch (error) {
                        console.warn('OCRè¨­å®šã‚¨ãƒ©ãƒ¼:', error);
                    }
                }

                // çµæœã®çµ±åˆã¨å€™è£œç”Ÿæˆ
                const correctAnswer = currentQuestions[currentQuestionIndex].answer;
                let recognizedText = '';
                let isCorrect = false;

                if (recognitionResults.length > 0) {
                    // æœ€ã‚‚ä¿¡é ¼åº¦ã®é«˜ã„çµæœã‚’é¸æŠ
                    recognitionResults.sort((a, b) => b.confidence - a.confidence);
                    recognizedText = recognitionResults[0].text;
                    
                    // æ­£è§£ãƒã‚§ãƒƒã‚¯
                    isCorrect = recognizedText === correctAnswer;
                    
                    if (!isCorrect) {
                        // é¡ä¼¼æ¼¢å­—å€™è£œã‚’ç”Ÿæˆ
                        const candidates = generateSimilarKanji(correctAnswer);
                        const allCandidates = [...new Set([recognizedText, correctAnswer, ...candidates])];
                        
                        // å€™è£œãŒè¤‡æ•°ã‚ã‚‹å ´åˆã¯é¸æŠè‚¢ã‚’è¡¨ç¤º
                        if (allCandidates.length > 1) {
                            showCandidates(allCandidates, correctAnswer);
                            return;
                        }
                    }
                } else {
                    // èªè­˜å¤±æ•—æ™‚ã¯å€™è£œã‚’è¡¨ç¤º
                    const candidates = generateSimilarKanji(correctAnswer);
                    showCandidates([correctAnswer, ...candidates], correctAnswer);
                    return;
                }

                // çµæœè¡¨ç¤º
                if (isCorrect) {
                    score++;
                    showResult(true, 'æ­£è§£ï¼', recognizedText);
                } else {
                    showResult(false, `ä¸æ­£è§£ã€‚æ­£è§£ã¯ã€Œ${correctAnswer}ã€ã§ã™ã€‚`, recognizedText || 'èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
                
                updateDisplay();
                
            } catch (error) {
                console.error('æ–‡å­—èªè­˜ã‚¨ãƒ©ãƒ¼:', error);
                showResult(false, 'æ–‡å­—èªè­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ–‡å­—ã‚’ã‚‚ã†ä¸€åº¦ã¯ã£ãã‚Šã¨æ›¸ã„ã¦ãã ã•ã„ã€‚', 'èªè­˜ã‚¨ãƒ©ãƒ¼');
            } finally {
                showProcessing(false);
            }
        }

        // å€™è£œè¡¨ç¤º
        function showCandidates(candidates, correctAnswer) {
            elements.candidateButtons.innerHTML = '';
            
            candidates.forEach(candidate => {
                const button = document.createElement('button');
                button.className = 'candidate-btn';
                button.textContent = candidate;
                button.onclick = () => selectCandidate(candidate, correctAnswer);
                elements.candidateButtons.appendChild(button);
            });
            
            elements.candidatesSection.style.display = 'block';
            showProcessing(false);
        }

        // å€™è£œé¸æŠ
        function selectCandidate(selectedKanji, correctAnswer) {
            hideCandidates();
            
            const isCorrect = selectedKanji === correctAnswer;
            
            if (isCorrect) {
                score++;
                showResult(true, 'æ­£è§£ï¼', selectedKanji);
            } else {
                showResult(false, `ä¸æ­£è§£ã€‚æ­£è§£ã¯ã€Œ${correctAnswer}ã€ã§ã™ã€‚`, selectedKanji);
            }
            
            updateDisplay();
        }

        // å€™è£œéè¡¨ç¤º
        function hideCandidates() {
            elements.candidatesSection.style.display = 'none';
        }

        // å‡¦ç†ä¸­è¡¨ç¤º
        function showProcessing(show) {
            elements.processingSection.style.display = show ? 'block' : 'none';
            elements.processingText.textContent = show ? 'é«˜ç²¾åº¦OCRã§æ–‡å­—ã‚’èªè­˜ä¸­...' : '';
            elements.checkBtn.disabled = show;
        }

        // çµæœè¡¨ç¤º
        function showResult(isCorrect, feedback, answer) {
            elements.resultSection.style.display = 'block';
            elements.resultSection.className = `result-section ${isCorrect ? 'result-correct' : 'result-incorrect'}`;
            elements.resultFeedback.textContent = feedback;
            elements.resultAnswer.textContent = `èªè­˜çµæœ: ${answer}`;
            
            elements.checkBtn.style.display = 'none';
            elements.nextBtn.style.display = 'inline-flex';
        }

        // çµæœéè¡¨ç¤º
        function hideResult() {
            elements.resultSection.style.display = 'none';
            elements.checkBtn.style.display = 'inline-flex';
            elements.nextBtn.style.display = 'none';
        }

        // æ¬¡ã®å•é¡Œ
        function nextQuestion() {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                clearCanvas();
                updateDisplay();
            } else {
                showFinalScore();
            }
        }

        // æœ€çµ‚ã‚¹ã‚³ã‚¢è¡¨ç¤º
        function showFinalScore() {
            const percentage = Math.round((score / currentQuestions.length) * 100);
            let message = '';
            
            if (percentage >= 80) {
                message = 'ğŸ‰ ç´ æ™´ã‚‰ã—ã„ï¼';
            } else if (percentage >= 60) {
                message = 'ğŸ‘ è‰¯ãã§ãã¾ã—ãŸï¼';
            } else {
                message = 'ğŸ’ª ã‚‚ã†å°‘ã—é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼';
            }
            
            const gradeText = currentGrade === 0 ? 'å…¨å­¦å¹´' : `${currentGrade}å¹´ç”Ÿ`;
            
            const finalScoreDiv = document.createElement('div');
            finalScoreDiv.className = 'final-score';
            finalScoreDiv.innerHTML = `
                <h3>${message}</h3>
                <div style="font-size: 1.5em; margin: 15px 0;">
                    ${gradeText}ã®æ¼¢å­—ãƒ†ã‚¹ãƒˆ<br>
                    æœ€çµ‚ã‚¹ã‚³ã‚¢: ${score}/${currentQuestions.length} (${percentage}%)
                </div>
                <button class="btn btn-next" onclick="resetTest()">
                    ğŸ”„ ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦
                </button>
                <button class="btn btn-grade" onclick="backToGradeSelection()">
                    ğŸ“š å­¦å¹´é¸æŠã«æˆ»ã‚‹
                </button>
            `;
            
            elements.resultSection.replaceWith(finalScoreDiv);
            elements.nextBtn.style.display = 'none';
        }

        // ãƒ†ã‚¹ãƒˆãƒªã‚»ãƒƒãƒˆ
        function resetTest() {
            currentQuestionIndex = 0;
            score = 0;
            
            if (currentGrade === 0) {
                const allQuestions = Object.values(kanjiQuestions).flat();
                currentQuestions = shuffleArray(allQuestions).slice(0, 20);
            } else {
                currentQuestions = shuffleArray([...kanjiQuestions[currentGrade]]).slice(0, 10);
            }
            
            clearCanvas();
            updateDisplay();
            
            // æœ€çµ‚ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’å‰Šé™¤
            const finalScore = document.querySelector('.final-score');
            if (finalScore) {
                finalScore.replaceWith(elements.resultSection);
            }
            
            hideResult();
            hideCandidates();
        }

        // è¡¨ç¤ºæ›´æ–°
        function updateDisplay() {
            if (!currentQuestions || currentQuestions.length === 0) return;
            
            const currentQ = currentQuestions[currentQuestionIndex];
            
            elements.currentQuestion.textContent = currentQuestionIndex + 1;
            elements.totalQuestions.textContent = currentQuestions.length;
            elements.currentScore.textContent = score;
            elements.questionText.innerHTML = currentQ.text;
            elements.questionHint.textContent = currentQ.hint;
            
            if (currentGrade === 0) {
                elements.gradeInfo.textContent = 'å°å­¦æ ¡å…¨å­¦å¹´ã®æ¼¢å­—';
            } else {
                elements.gradeInfo.textContent = `å°å­¦æ ¡${currentGrade}å¹´ç”Ÿã®æ¼¢å­—`;
            }
        }
    </script>
</body>
</html>
